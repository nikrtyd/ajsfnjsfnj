<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <!-- STYLE -->
  <style>
    body,
    main {
      margin: 0;
      background: #ddd;
      color: #111;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      font-size: 18px;
      height: 100vh;
    }

    .flex {
      display: flex;
    }

    .ai-c {
      align-items: center;
    }

    .jc-c {
      justify-content: center;
    }

    .dir-col {
      flex-direction: column;
    }

    .ta-c {
      text-align: center;
    }

    .hide {
      display: none;
    }

    td {
      vertical-align: middle;
      text-align: center;
      min-width: 125px;
      padding: 6px;
    }

    td:not([contenteditable]) {
      background: #d9d9d9;
      color: #404040;
    }

    .m-t {
      margin-top: 30px;
    }

    .m-l {
      margin-left: 5px;
    }

    button {
      padding: 10px 20px;
      background: #bbb;
      color: #111;
      border: 2px solid #555;
      font: inherit;
    }

    button:active {
      background: #ccc;
      border: 2px solid #111;
    }

    .info--show::after {
      content: 'Все значения округлены до ближайших целых.';
      margin-left: 100px;
      font-size: 14px;
      color: #888;
    }

    #restrictionSystem::before {
      content: '{';
      position: absolute;
      margin-top: -22px;
      margin-left: -32px;
      font-size: 72px;
      color: #ccc;
    }

    .label {
      color: #999;
    }

    .error>*:not(.info),
    .error>.info--show::after {
      display: none;
    }
  </style>
</head>

<body>
  <!-- MAIN CONTENT -->
  <main class="flex ai-c jc-c dir-col">
    <!-- Table -->
    <table cellspacing="0" cellpadding="0" border="1">
      <tbody>
        <tr>
          <td rowspan="2">Вид корма</td>
          <td colspan="3" width="374">Количество пит. в ед. корма</td>
          <td rowspan="2">Стоим. ед. корма в тенге</td>
        </tr>
        <tr>
          <td>S₁</td>
          <td>S₂</td>
          <td>S₃</td>
        </tr>
        <tr>
          <td>1</td>
          <td contenteditable="true"></td>
          <td contenteditable="true"></td>
          <td contenteditable="true"></td>
          <td class="forTargetFunction" contenteditable="true"></td>
        </tr>
        <tr>
          <td>2</td>
          <td contenteditable="true"></td>
          <td contenteditable="true"></td>
          <td contenteditable="true"></td>
          <td class="forTargetFunction" contenteditable="true"></td>
        </tr>
        <tr>
          <td>Рацион</td>
          <td contenteditable="true"></td>
          <td contenteditable="true"></td>
          <td contenteditable="true"></td>
          <td></td>
        </tr>
      </tbody>
    </table>
    <section>
      <!-- Calculate -->
      <div class="m-t info">
        <button onclick="calculateAndOutput()" id="calculate">Рассчитать</button>
      </div>
      <!-- Target Function -->
      <div class="flex m-t result-sect hide">
        <span class="label">
          Целевая функция:
        </span>
        <span class="m-l result" id="function-result">
          нет функции
        </span>
      </div>
      <!-- Restriction System -->
      <section class="m-t hide restriction-sect">
        <span class="label">
          Система ограничений:<br>
        </span>
        <span id="restrictionSystem" class="ta-c">

        </span>
      </section>
      <!-- Calculation -->
      <section class="m-t">
        <span id="calculation" class="ta-c">

        </span>
      </section>
      <!-- Resulting function -->
      <section class="m-t">
        <span id="result" class="ta-c">

        </span>
      </section>
    </section>
  </main>
  <!-- SCRIPTS -->
  <script>
    // Задаём переменные, чтобы записывать туда наши действия
    let mainTable = document.querySelector('table');
    let functionResult = document.querySelector('#function-result');
    let restrictionSystem = document.querySelector('#restrictionSystem');
    let calculation = document.querySelector('#calculation');
    let result = document.querySelector('#result');
    let error = false;

    // Задаём переменные для функции
    let x1 = 0;
    let x2 = 0;
    let resultingPriceOfIntake = 0;

    // Для всех редактируемых ячеек таблицы, разрешим ввод только цифр
    for (let i = 0; i < mainTable.rows.length; i++) {
      for (let j = 0; j < mainTable.rows[i].cells.length; j++) {
        mainTable.rows[i].cells[j].onkeydown = function (e) {
          if (!e) e = window.event;
          var keyCode = e.keyCode || e.which;
          if (!e.ctrlKey && !e.metaKey && !e.altKey) {
            if (keyCode >= 48 && keyCode <= 57) {
              return true;
            }
            if (keyCode >= 96 && keyCode <= 105) {
              return true;
            }
            if (keyCode == 8 || keyCode == 46) {
              return true;
            }
            return false;
          }
        }
      }
    }

    // Функция вывода полного результата
    function calculateAndOutput() {
      // Перезаписываем переменные, чтобы на экране не оставалось предыдущее вычисление при повторном нажатии на кнопку
      mainTable = document.querySelector('table');
      functionResult = document.querySelector('#function-result');
      restrictionSystem = document.querySelector('#restrictionSystem');
      calculation = document.querySelector('#calculation');
      result = document.querySelector('#result');
      error = false;

      // Выводим полный результат на экран:
      let matrix = GetMatrix(mainTable);
      functionResult.innerHTML = GetTargetFunction(matrix);
      restrictionSystem.innerHTML = GetRestrictionSystem(matrix);
      calculation.innerHTML = Calculate(matrix);
      result.innerHTML = Result(x1, x2, matrix);

      // Вписываем стоимость всего рациона в таблицу
      document.querySelector('table').rows[mainTable.rows.length - 1].cells[mainTable.rows[mainTable.rows.length - 1].cells.length - 1].innerHTML = `<b>${resultingPriceOfIntake}</b>`;

      // Устраняем ошибку = 1x превращаем в x, Infinity превращаем в ∞, все что умножается на 0, приравниваем к нулю.
      document.body.innerHTML = document.body.innerHTML.replaceAll('<br>1x', '<br>x').replaceAll(' 1x', ' x').replaceAll('Infinity', '∞').replaceAll('NaN', 'не число').replaceAll('<br>0x₁', '<br>0').replaceAll('<br>0x₂', '<br>0').replaceAll(' 0x₁', ' 0').replaceAll(' 0x₂', ' 0');

      // Устраняем ошибку - если было два раза написано что из чего вытекает при поиске x2 (не берём в расчёт место, где мы ищем x1 - там еще один раз), то убираем одну строку
      let x2Matches = document.body.innerHTML.match(/<br>x₁ = \d+ - \d+x₂/g);
      if (x2Matches.length == 3)
        document.body.innerHTML = document.body.innerHTML.replace(x2Matches[0], '');

      // Если произошла ошибка в вычислениях, то прячем все вычисления. Если нет - показываем.
      if (error) {
        document.querySelector('section').classList.add('error');
        document.querySelector('table').rows[mainTable.rows.length - 1].cells[mainTable.rows[mainTable.rows.length - 1].cells.length - 1].classList.add('error');
      }
      else {
        document.querySelector('section').classList.remove('error');
        document.querySelector('table').rows[mainTable.rows.length - 1].cells[mainTable.rows[mainTable.rows.length - 1].cells.length - 1].classList.remove('error');
      };

      // Показываем информацию.
      document.querySelector('.info').classList.add('info--show');
      document.querySelector('.restriction-sect').classList.remove('hide');
      document.querySelector('.result-sect').classList.remove('hide');
    }

    // Округляем все числа на странице до ближайшего целого.
    function RoundAllNumbers() {
      let tempHtml = document.body.innerHTML;
      let matches = tempHtml.match(/\-?\d+\.\d+/g);
      for (let i = 0; i < matches.length; i++) {
        tempHtml = tempHtml.replace(matches[i], Math.round(Number.parseFloat(matches[i])));
      }
      document.body.innerHTML = tempHtml;
    }

    // Получаем матрицу из таблицы
    function GetMatrix(table) {
      const matrix = [,];
      // не берем в расчет левый и верхний края таблицы, отсюда начинается матрица: i (ряд) = 2; j (столб.) = 1
      for (let i = 2; i < table.rows.length; i++) {
        let rowData = [];
        for (let j = 1; j < table.rows[i].cells.length; j++) {
          // Проверка, если число меньше нуля (не проверяем последнюю запись в последнем ряду - там нет ничего для ввода, туда выводится результат)
          if (j !== table.rows[i].cells.length - 1)
            Validate(Number.parseInt(table.rows[i].cells[j].innerText));
          rowData.push(parseInt(table.rows[i].cells[j].innerText));
        }
        matrix[i - 2] = rowData;
      }
      return matrix;
    }

    // Выводим целевую функцию из матрицы
    function GetTargetFunction(matrix) {
      return `f(x) = <b>${matrix[0][3]}</b>x₁ + <b>${matrix[1][3]}</b>x₂ → <i>min</i>`;
    }

    // Выводим систему ограничений для S1, S2 и S3 соответственно
    function GetRestrictionSystem(matrix) {
      let output = '';
      for (let i = 0; i < matrix.length; i++) {
        let restriction = `${matrix[0][i]}x₁ + ${matrix[1][i]}x₂ ≥ ${matrix[2][i]}`;
        output += `${restriction}<br>`;
      }
      return output;
    }

    // Вычисляем x1, x2
    function Calculate(matrix) {
      // получаем строки для системы ограничений - нужно только для того, чтобы показать, из чего что вытекает
      let restrictionSystemStrings = GetRestrictionSystem(matrix).split('<br>');
      let output = '';
      // x2:      
      output = `<span class=\'label\'>Из<b> ${restrictionSystemStrings[1]}</b> вытекает:</span><br>`;
      output += `${matrix[0][1]}x₁ = ${matrix[2][1]} - ${matrix[1][1]}x₂<br>`;

      let temp21 = Math.round(matrix[2][1] / matrix[0][1]);
      let temp11 = Math.round(matrix[1][1] / matrix[0][1]);

      output += `x₁ = ${temp21} - ${temp11}x₂<br>`;
      output += `<span class=\'label\'>Подставляем в<b> ${restrictionSystemStrings[0]}</b> вместо x₁ это значение:</span><br>`;
      output += `${matrix[0][0]}(${temp21} - ${temp11}x₂) + ${matrix[1][0]}x₂ = ${matrix[2][0]}<br>`;
      output += `${matrix[0][0] * temp21} - ${matrix[0][0] * temp11}x₂ + ${matrix[1][0]}x₂ = ${matrix[2][0]}<br>`;
      output += `${-matrix[0][0] * temp11}x₂ + ${matrix[1][0]}x₂ = ${matrix[2][0]} - ${matrix[0][0] * temp21}<br>`;
      output += `${-matrix[0][0] * temp11 + matrix[1][0]}x₂ = ${matrix[2][0] - matrix[0][0] * temp21}<br>`;
      x2 = Math.round((matrix[2][0] - matrix[0][0] * temp21) / (-matrix[0][0] * temp11 + matrix[1][0]));
      output += `<b>x₂ = ${x2}</b>`;
      output += '<span class=\'label\'><b> (кг.)</b></span><br>';
      // x1, выражаем через x2:
      output += `x₁ = ${temp21} - ${matrix[1][1]}x₂<br>`;
      output += `x₁ = ${temp21} - ${matrix[1][1] * x2}<br>`;
      x1 = temp21 - matrix[1][1] * x2;
      output += `<b>x₁ = ${x1}</b>`;
      output += '<span class=\'label\'><b> (кг.)</b></span><br>';
      ValidateX(x1, x2);
      return output;
    }

    // Проверяем, не меньше ли x1 и x2 чем нуль.
    function ValidateX(x1, x2) {
      // если меньше:
      if (x1 <= 0 || x2 <= 0) {
        // прячем вычисления:
        error = true;
        return alert('Возникла ошибка - ни x₁, ни x₂ не могут быть равны нулю или быть меньше нуля. Пожалуйста, попробуйте ввести данные снова.');
      };
    }

    // Проверяем, не равно ли число в таблице нулю либо оно меньше нуля (применяется в цикле)
    function Validate(num) {
      // если меньше:
      if (num <= 0) {
        // прячем вычисления:
        error = true;
        return alert('Возникла ошибка. Попробуйте ввести данные снова.');
      }
    }

    // Подставляем x1, x2 в целевую функцию
    function Result(x1, x2, matrix) {
      let output = `<span class=\'label\'>Подставляем значения в целевую функцию <b>${functionResult.innerText.split(' →')[0]}</b>:</span><br>`;
      output += `f(x) = ${matrix[0][3]} * ${Math.round(x1)} + ${matrix[1][3]} * ${x2}<br>`
      output += `f(x) = ${matrix[0][3] * x1} + ${matrix[1][3] * x2}<br>`
      resultingPriceOfIntake = matrix[0][3] * x1 + matrix[1][3] * x2;
      output += `<b>f(x) = ${resultingPriceOfIntake}</b>`
      output += '<span class=\'label\'><b> (тг.)</b></span><br>';
      return output;
    }
  </script>
</body>

</html>
